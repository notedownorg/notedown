# Copyright 2025 Notedown Authors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: nightly

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  cleanup:
    name: cleanup
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Delete old nightly releases
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CUTOFF_DATE=$(date -d '3 days ago' --iso-8601)
          
          gh api repos/${{ github.repository }}/releases \
            --jq ".[] | select(.tag_name | test(\"nightly\")) | select(.created_at < \"${CUTOFF_DATE}\") | .id" \
            | while read release_id; do
              echo "Deleting old nightly release ID: $release_id"
              gh api -X DELETE repos/${{ github.repository }}/releases/$release_id || true
            done

  build:
    name: nightly
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate nightly version
        id: version
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          NIGHTLY_VERSION="v0.0.0-nightly.$(date +%Y%m%d).${SHORT_SHA}"
          echo "version=$NIGHTLY_VERSION" >> $GITHUB_OUTPUT
          echo "Generated nightly version: $NIGHTLY_VERSION"

      - name: Build with GoReleaser
        run: nix develop --command goreleaser build --config .goreleaser.notedown-language-server.nightly.yaml --clean --parallelism 2
        env:
          NIGHTLY_VERSION: ${{ steps.version.outputs.version }}

      - name: Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NIGHTLY_VERSION: ${{ steps.version.outputs.version }}
        run: |
          # Create the release
          gh release create "${NIGHTLY_VERSION}" \
            --title "Nightly Build ${NIGHTLY_VERSION}" \
            --notes "## üåô Nightly Build

          This is an **automated nightly build** of Notedown Language Server from the latest \`main\` branch.

          ### ‚ö†Ô∏è  Important Notes
          - **Development Build**: This build may contain experimental features and unfinished changes
          - **Not for Production**: Use stable releases for production environments  
          - **No Support**: Nightly builds are provided as-is without support guarantees
          - **Auto-cleanup**: Old nightly builds are automatically removed after 3 days

          ### üì¶ Installation

          #### Linux x86_64
          \`\`\`bash
          curl -L "https://github.com/notedownorg/notedown/releases/download/${NIGHTLY_VERSION}/notedown-language-server_Linux_x86_64.tar.gz" | tar -xz && chmod +x notedown-language-server && sudo mv notedown-language-server /usr/local/bin/
          \`\`\`
          
          #### Linux ARM64
          \`\`\`bash
          curl -L "https://github.com/notedownorg/notedown/releases/download/${NIGHTLY_VERSION}/notedown-language-server_Linux_arm64.tar.gz" | tar -xz && chmod +x notedown-language-server && sudo mv notedown-language-server /usr/local/bin/
          \`\`\`
          
          #### macOS Intel
          \`\`\`bash
          curl -L "https://github.com/notedownorg/notedown/releases/download/${NIGHTLY_VERSION}/notedown-language-server_Darwin_x86_64.tar.gz" | tar -xz && chmod +x notedown-language-server && sudo mv notedown-language-server /usr/local/bin/
          \`\`\`
          
          #### macOS Apple Silicon
          \`\`\`bash
          curl -L "https://github.com/notedownorg/notedown/releases/download/${NIGHTLY_VERSION}/notedown-language-server_Darwin_arm64.tar.gz" | tar -xz && chmod +x notedown-language-server && sudo mv notedown-language-server /usr/local/bin/
          \`\`\`

          #### Verify Installation
          \`\`\`bash
          notedown-language-server version
          \`\`\`

          #### Start Language Server
          \`\`\`bash
          notedown-language-server serve
          \`\`\`

          ### üîç What's Changed
          This nightly build includes all changes committed to \`main\` up to commit \`$(git rev-parse --short HEAD)\`.

          Built on: \`$(date -u '+%Y-%m-%d %H:%M:%S UTC')\`" \
            --prerelease \
            dist/notedown-language-server_*